


CREATE   VIEW [dbo].[WSOL_VW_PBI_EDUCATION_ROSTER_DETAIL]
AS

WITH SCHEDULE_ACL (SCHID, IDAGENT, IDPROG, IDCLIENT) AS
(
 SELECT SCH.ID, SCH.IDAGENT, SCH.IDPROG, PRG.IDCLIENT
   FROM SCHACL SCH, PROGRAM PRG
  WHERE SCH.IDPROG = PRG.ID
    AND SCH.IDPROG <> 2508
)

SELECT
 DAT.*
,CASE WHEN DAT.COMPLETION_STATUS <> 'Yes' THEN ''
	  ELSE CASE WHEN ISNULL(DAT.AGENT_ID,'') = '' THEN 'NO EMAIL MATCH'
				WHEN ISNULL(SH.IDAGENT,'')   = '' THEN 'NO'
				ELSE 'YES' END
	  END								AS ACTIVE_AGENT
FROM
(SELECT
 PATS.AGENT_NAME						AS AGENT_NAME
,ISNULL(PATS.ALTERNATE_AGENT_NAME,'')	AS ALTERNATE_AGENT_NAME
,ISNULL(PATS.AGENT_EMAIL,'')			AS AGENT_EMAIL
,ISNULL(PATS.CATS_ID,'')				AS CATS_ID
,  PR.[NAME]							AS PROJECT_NAME
,  CL.[NAME]							AS CLIENT_NAME
,PATS.ROSTER_NUMBER						AS ROSTER_NUMBER
,ISNULL(PATS.SUBHEADING,'')				AS SUBHEADING
,  TY.[NAME]							AS TYPE_OF_PREPARATION
,PATS.PREP_START_DATE					AS PREP_START_DATE
,PATS.PREP_END_DATE						AS PREP_END_DATE
,  ST.[NAME]							AS AGENT_STATUS
,PATS.COMPLETION_STATUS					AS COMPLETION_STATUS
,  RE.[NAME]							AS REASON
,PATS.DAYS_ATTENDED						AS DAYS_ATTENDED
,PATS.TRAINER_NAME						AS TRAINER_NAME
,PATS.COMMENTS							AS COMMENTS
,ISNULL(PATS.AGENT_ID,'')				AS AGENT_ID
,  PR.IDCLIENT							AS IDCLIENT
FROM
(SELECT
 CASE WHEN PA.MIDDLENAME = '' THEN CONCAT(PA.FIRSTNAME,' ',PA.LASTNAME)
	  ELSE CONCAT(PA.FIRSTNAME,' ',PA.MIDDLENAME,' ',PA.LASTNAME) END		AS AGENT_NAME
,CASE WHEN ISNULL(AG.FNAME,'') = '' THEN AG.LNAME
	  WHEN ISNULL(AG.LNAME,'') = '' THEN AG.FNAME
	  ELSE CONCAT(AG.FNAME,' ',AG.LNAME) END								AS ALTERNATE_AGENT_NAME
,AG.EMAIL																	AS AGENT_EMAIL
,AP.AGENTIDENTNUM															AS CATS_ID
,AG.ID																		AS AGENT_ID
,PD.ROSTERNUMBER															AS ROSTER_NUMBER
,PD.SUBHEADING																AS SUBHEADING
,PD.DATESTART																AS PREP_START_DATE
,PD.DATESTOP																AS PREP_END_DATE
,PD.ISDELETED																AS DELETED_FLAG
,CASE WHEN PA.COMPLETION = 'Y' THEN 'Yes'
	  WHEN PA.COMPLETION = 'N' THEN 'No'
	  WHEN PA.COMPLETION = 'A' THEN 'DP'
	  WHEN PA.COMPLETION = 'M' THEN 'MR'
	  ELSE PA.COMPLETION END												AS COMPLETION_STATUS
,PA.DAYSATTENDED															AS DAYS_ATTENDED
,CASE WHEN PT.LASTNAME = '' THEN PT.FIRSTNAME
	  ELSE CONCAT(PT.FIRSTNAME,' ',PT.LASTNAME) END							AS TRAINER_NAME
,ISNULL(PA.COMMENTS,'')														AS COMMENTS 
,PD.IDPROJECT																AS IDPROJECT
,AP.IDAPPSTATUS																AS IDAPPSTATUS
,PA.IDPREPARATIONREASON														AS IDPREPARATIONREASON
,PD.IDTYPEOFPREPARATION														AS IDTYPEOFPREPARATION
FROM PREPARATIONAGENT PA
LEFT JOIN AGENTS				AG ON PA.EMAIL					= AG.EMAIL
LEFT JOIN APPLICANT				AP ON PA.EMAIL					= AP.EMAIL
LEFT JOIN PREPARATIONDATA		PD ON PA.IDPREPARATIONDATA		= PD.IDPREPARATIONDATA
LEFT JOIN PREPARATIONTRAINER	PT ON PD.IDPREPARATIONTRAINER	= PT.IDPREPARATIONTRAINER
WHERE PD.ISDELETED <> 'Y'
  --AND PA.IDPREPARATIONDATA = 4522
) PATS
LEFT JOIN PROJECT			PR ON PATS.IDPROJECT			= PR.IDPROJECT
LEFT JOIN APPSTATUS			ST ON PATS.IDAPPSTATUS			= ST.IDAPPSTATUS
LEFT JOIN PREPARATIONREASON	RE ON PATS.IDPREPARATIONREASON	= RE.IDPREPARATIONREASON
LEFT JOIN CLIENT			CL ON PR.IDCLIENT				= CL.ID
LEFT JOIN TYPEOFPREPARATION	TY ON PATS.IDTYPEOFPREPARATION	= TY.IDTYPEOFPREPARATION
--WHERE PATS.IDPROJECT			= PR.IDPROJECT
--  AND PATS.IDAPPSTATUS			= ST.IDAPPSTATUS
--  AND PATS.IDPREPARATIONREASON	= RE.IDPREPARATIONREASON
--  AND PR.IDCLIENT				= CL.ID
--  AND PATS.IDTYPEOFPREPARATION	= TY.IDTYPEOFPREPARATION
--  AND PATS.DELETED_FLAG <> 'Y'
) DAT
 LEFT JOIN SCHEDULE_ACL SH ON DAT.AGENT_ID = SH.IDAGENT
						  AND DAT.IDCLIENT = SH.IDCLIENT
GROUP BY
 DAT.AGENT_NAME
,DAT.ALTERNATE_AGENT_NAME
,DAT.AGENT_EMAIL
,DAT.CATS_ID
,DAT.PROJECT_NAME
,DAT.CLIENT_NAME
,DAT.ROSTER_NUMBER
,DAT.SUBHEADING
,DAT.TYPE_OF_PREPARATION
,DAT.PREP_START_DATE
,DAT.PREP_END_DATE
,DAT.AGENT_STATUS
,DAT.COMPLETION_STATUS
,DAT.REASON
,DAT.DAYS_ATTENDED
,DAT.TRAINER_NAME
,DAT.COMMENTS
,DAT.AGENT_ID
,DAT.IDCLIENT
,CASE WHEN DAT.COMPLETION_STATUS <> 'Yes' THEN ''
	  ELSE CASE WHEN ISNULL(DAT.AGENT_ID,'') = '' THEN 'NO EMAIL MATCH'
				WHEN ISNULL(SH.IDAGENT,'')   = '' THEN 'NO'
				ELSE 'YES' END
	  END

GO