
CREATE PROCEDURE [dbo].[uspWSOL_SSRS_AUTO_INVOICE_UNACCEPTED_INVOICES]
 @DATE_BEG			DATETIME
,@DATE_END			DATETIME
,@CLIENT_ID			VARCHAR(200) --Vis. Def='ALL'
,@PROJECT_ID		VARCHAR(200) --Vis. Def='ALL'
,@PSW				VARCHAR(10)  --Hid. Def='NONE'
,@EXECUTIONER		VARCHAR(3)   --Hid. Def='MAN'  MANual,SUBscription
,@RPT_TYPE			VARCHAR(3)   --Hid. Def='DLY'  
AS
BEGIN
SET NOCOUNT ON 

--  EXECUTE [dbo].[uspWSOL_SSRS_AUTO_INVOICE_UNACCEPTED_INVOICES] '06/19/2017','06/19/2017','ALL','ALL','','MAN','DLY'

--=============================================================================
SET DATEFIRST 1  --1=MONDAY  7=SUNDAY  --DW = M,T,W,T,F,S,S
--=============================================================================
DECLARE
 @DTM_BEG AS DATETIME
,@DTM_END AS DATETIME
	IF @DATE_BEG < '01/01/1901' OR @RPT_TYPE = 'WKL' BEGIN	--WEEKLY - Run report for 7 days from current day to current day.
			--Dates passed in are for PREVIOUS DAY:
		SET @DTM_BEG = CAST(CONVERT(VARCHAR(10),@DATE_BEG,101) AS DATETIME)				-- @DATE_BEG already starting at yesterday's date.
		SET @DTM_BEG = CASE WHEN DATEPART(DW,@DTM_BEG) = 1 THEN @DTM_BEG				-- MONDAY
							ELSE DATEADD(DD,-6,@DTM_BEG) END								-- SET START DATE TO PAST MONDAY
		SET @DTM_END = CAST(CONVERT(VARCHAR(10),@DATE_END,101) AS DATETIME)				-- + 1 --DONE BELOW. 

		IF @DTM_END >  DBO.GETDATE() - 1 BEGIN											--DBO.GETDATE() -1 IS GOING TO ALSO INCLUDE SOME TIME AFTER MIDNIGHT.  THIS IS CORRECT !
			SET @DTM_END = CAST(CONVERT(VARCHAR(10),DBO.GETDATE() - 1,101) AS DATETIME)
		END
	END
	ELSE BEGIN  --DAILY - Run report for YESTERDAY, 1 Day ONLY.
		SET @DTM_BEG = CAST(CONVERT(VARCHAR(10),@DATE_BEG,101) AS DATETIME)				--@DATE_BEG already starting at yesterday's date.
		SET @DTM_END = CAST(CONVERT(VARCHAR(10),@DATE_END,101) AS DATETIME)				-- + 1 --done below.
	END

SET @DTM_END    = @DTM_END + 1  --EVERYTHING ABOVE, @DTM_END IS FOR EXACT DATE RANGE NEEDED. ONE IS ADDED SO WHERE CLAUSE " < @DTM_END" WORKS.

--=======================================================================================
--	SET MULTI-VALUE PARAMETERS:
--=======================================================================================
SET @CLIENT_ID	= ',' + LTRIM(RTRIM(REPLACE(@CLIENT_ID	,'ALL','0'))) + ','
SET @PROJECT_ID	= ',' + LTRIM(RTRIM(REPLACE(@PROJECT_ID	,'ALL','0'))) + ','

--==================================
--	CREATE TMP TABLE:
--==================================
IF OBJECT_ID('TEMPDB..#WSOL_SSRS_AUTO_INVOICE_UNACCEPTED_INVOICES') IS NOT NULL BEGIN
   DROP TABLE #WSOL_SSRS_AUTO_INVOICE_UNACCEPTED_INVOICES
END
CREATE TABLE #WSOL_SSRS_AUTO_INVOICE_UNACCEPTED_INVOICES
(AGENT_FIRST_NAME				VARCHAR(100)
,AGENT_LAST_NAME				VARCHAR(100)
,[EMAIL]						VARCHAR(150)
,CLIENT_ID						VARCHAR(20)
,CLIENT_NAME					VARCHAR(500)
,PROJECT_ID						VARCHAR(20)
,PROJECT_NAME					VARCHAR(500)
,RATE							DECIMAL(10,2)
,[VALUE]						DECIMAL(10,2)
,TOTAL_COST						DECIMAL(10,2)
,RECORD_DATETIME				DATETIME
,RESOURCE_NAME					VARCHAR(500)
)

INSERT INTO #WSOL_SSRS_AUTO_INVOICE_UNACCEPTED_INVOICES
SELECT
 ISNULL(DAT.AGENT_FIRST_NAME,'')
,ISNULL(DAT.AGENT_LAST_NAME	,'')
,ISNULL(DAT.EMAIL			,'')
,ISNULL(DAT.CLIENT_ID		,0)
,ISNULL(DAT.CLIENT_NAME		,'')
,ISNULL(DAT.PROJECT_ID		,0)
,ISNULL(DAT.PROJECT_NAME	,'')
,DAT.RATE
,DAT.[VALUE]
,DAT.TOTAL_COST
,DAT.RECORD_DATETIME
,ISNULL(DAT.RESOURCE_NAME	,'')
FROM
(	
	SELECT
	 A.FNAME						AS AGENT_FIRST_NAME
	,A.LNAME						AS AGENT_LAST_NAME
	,A.EMAIL						AS EMAIL
	,C.ID							AS CLIENT_ID
	,C.[NAME]						AS CLIENT_NAME
	,I.IDPROJECT					AS PROJECT_ID
	,P.[NAME]						AS PROJECT_NAME
	,I.RATE							AS RATE
	,I.[VALUE]						AS [VALUE]
	,I.TOTAL						AS TOTAL_COST
	,I.DATEW						AS RECORD_DATETIME
	,CONCAT(A.FNAME,' ',A.LNAME)	AS RESOURCE_NAME
	--SELECT *
	FROM AUTOINVTOTAL	I
	LEFT JOIN AGENTS	A ON I.IDAGENT		= A.ID
	LEFT JOIN PROJECT	P ON I.IDPROJECT	= P.IDPROJECT
	LEFT JOIN CLIENT	C ON P.IDCLIENT		= C.ID
	
	WHERE I.RECSTATUS = 'N'
	  AND ( @CLIENT_ID	IN (',0,') OR CHARINDEX(',' + RTRIM(C.ID)		 + ',',@CLIENT_ID) > 0   ) --C.ID		 = @CLIENT_ID
	  AND ( @PROJECT_ID IN (',0,') OR CHARINDEX(',' + RTRIM(P.IDPROJECT) + ',',@PROJECT_ID)> 0   ) --P.IDPROJECT = @PROJECT_ID
	 
) DAT

--=================================================================================================
--	RETURN DATASET:
--=================================================================================================

SELECT 
 CONVERT(VARCHAR(10),@DTM_BEG,101) + '-' + CONVERT(VARCHAR(10),@DTM_END - 1,101)  AS DATE_RANGE
,V.*
FROM	#WSOL_SSRS_AUTO_INVOICE_UNACCEPTED_INVOICES		V
ORDER BY 
 V.CLIENT_NAME
,V.PROJECT_NAME
,V.RESOURCE_NAME

--===============================
EARLY_EXIT:
--===============================
--IMPOSSIBLE:  SELECT 1/0    POSSIBLE:  SELECT 0/1

END

GO