CREATE   VIEW [dbo].[WSOL_VW_PBI_AGENT_LAST_LOGIN_DETAIL]
AS

WITH SCHEDULE_ACL (SCHID, IDAGENT, IDPROG, PRGNAME, IDCLIENT) AS
(
 SELECT SCH.ID, SCH.IDAGENT, SCH.IDPROG, PRG.[NAME], PRG.IDCLIENT
   FROM SCHACL SCH, PROGRAM PRG
  WHERE SCH.IDPROG = PRG.ID
    AND PRG.ISSHOW = 1
	--AND SCH.IDAGENT = 333
  --ORDER BY SCH.IDAGENT
)

	,MANUAL_MAP_DATA (FIELDNAME, IDPROGRAM, IDMANUALMAPDATA, IDAGENT, IDMANUALMAPFLD, USERID, DATEW) AS
(
 SELECT FLD.FIELDNAME, FLD.IDPROGRAM, MAP.IDMANUALMAPDATA, MAP.IDAGENT, MAP.IDMANUALMAPFLD, MAP.USERID, MAP.DATEW
   FROM MANUALMAPDATA MAP
	    LEFT JOIN MANUALMAPFLD FLD ON MAP.IDMANUALMAPFLD = FLD.IDMANUALMAPFLD
   WHERE ISNULL(MAP.USERID,'') <> ''
	 AND FLD.STATUS = 'Active'
	 --AND MAP.IDAGENT = 333
)

	,AGENTS_TO_EXCLUDE (IDAGENT,EXCLUDE) AS
(
 SELECT ACL.IDAGENT, 'Y' AS EXCLUDE
   FROM  SCHACL		ACL
		,PROGRAM	PRG
		,CLIENT		CLI
  WHERE ACL.IDPROG	 = PRG.ID
    AND PRG.ISSHOW	 = 1
	AND PRG.IDCLIENT = CLI.ID
	AND CLI.ID IN (55,145)  --WSOL & WSOL IT Test Client
 GROUP BY
  ACL.IDAGENT
)

	,NEXT_SCHEDULE_DATE (IDAGENT, IDPROGR,SCHEDULE_DATE) AS
(
 SELECT
  SCH.IDAGENT
 ,SCH.IDPROGR
 ,MIN(SCH.DATESCH)	AS SCHEDULE_DATE
 FROM SCHTIMES_AGENT	SCH
 WHERE SCH.DATESCH >= DATEADD(D, -1, DBO.GETDATE())
 GROUP BY
  SCH.IDAGENT
 ,SCH.IDPROGR
)

SELECT
 SCH.IDAGENT					AS IDAGENT
--,SCH.IDPROG					AS IDPROG
,AGT.REALFNAME					AS AGENT_FIRST_NAME
,AGT.REALLNAME					AS AGENT_LAST_NAME
,AGT.EMAIL						AS AGENT_EMAIL_ADDRESS
,APP.AGENTIDENTNUM				AS CATS_ID
,STA.[NAME]						AS CATS_STATUS
--,SCH.PRGNAME					AS SCHEDULE_ACL
--,ISNULL(MAP.USERID,'')			AS FIELD_MAP_ID
,CLI.[NAME]						AS CLIENT_NAME
,MAX(INV.LAST_LOGIN_DATE)		AS LAST_LOGIN_DATE
,CASE WHEN MAX(INV.LAST_LOGIN_DATE) IS NOT NULL THEN DATEDIFF(DAY,MAX(INV.LAST_LOGIN_DATE), CONVERT(DATE,DBO.GETDATE()))
	  ELSE NULL END				AS DAYS_SINCE_LAST_LOGIN
,MIN(NXT.SCHEDULE_DATE)			AS NXT_SCHEDULE_DATE
--,ISNULL(EXC.EXCLUDE,'N')		AS EXCLUDE_FLAG
FROM SCHEDULE_ACL SCH
LEFT JOIN AGENTS			AGT	ON SCH.IDAGENT		= AGT.ID
LEFT JOIN CLIENT			CLI	ON SCH.IDCLIENT		= CLI.ID
LEFT JOIN APPLICANT			APP	ON AGT.EMAIL		= APP.EMAIL
LEFT JOIN APPSTATUS			STA ON APP.IDAPPSTATUS	= STA.IDAPPSTATUS
LEFT JOIN MANUAL_MAP_DATA	MAP ON SCH.IDAGENT		= MAP.IDAGENT
							   AND SCH.IDPROG		= MAP.IDPROGRAM
LEFT JOIN WSOL_VW_AGENT_LAST_LOGIN INV ON CLI.[NAME] = INV.CLIENT_NAME
									  AND MAP.USERID = INV.INVOICE_MAP_KEY
LEFT JOIN AGENTS_TO_EXCLUDE EXC ON SCH.IDAGENT		= EXC.IDAGENT
LEFT JOIN NEXT_SCHEDULE_DATE NXT ON SCH.IDAGENT = NXT.IDAGENT
								AND SCH.IDPROG  = NXT.IDPROGR
WHERE ISNULL(EXC.EXCLUDE,'N') = 'N'

--ORDER BY SCH.IDAGENT
GROUP BY
 SCH.IDAGENT			--AS IDAGENT
--,SCH.IDPROG			--AS IDPROG
,AGT.REALFNAME			--AS AGENT_FIRST_NAME
,AGT.REALLNAME			--AS AGENT_LAST_NAME
,AGT.EMAIL				--AS AGENT_EMAIL_ADDRESS
,APP.AGENTIDENTNUM		--AS CATS_ID
,STA.[NAME]				--AS CATS_STATUS
--,SCH.PRGNAME			--AS SCHEDULE_ACL
--,MAP.USERID				--AS FIELD_MAP_ID
,CLI.[NAME]				--AS CLIENT_NAME
--,INV.LAST_LOGIN_DATE	--AS LAST_LOGIN_DATE
--,CASE WHEN MAX(INV.LAST_LOGIN_DATE) IS NOT NULL THEN DATEDIFF(DAY,MAX(INV.LAST_LOGIN_DATE), CONVERT(DATE,DBO.GETDATE()))
--	  ELSE NULL END				--AS DAYS_SINCE_LAST_LOGIN
--,ISNULL(EXC.EXCLUDE,'N')		--AS EXCLUDE_FLAG

-- SELECT * FROM [WSOL_VW_PBI_AGENT_LAST_LOGIN_DETAIL]
GO